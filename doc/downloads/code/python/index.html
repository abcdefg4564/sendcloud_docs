<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">   
    <link rel="canonical" href="http://sendcloud.sohu.com/downloads/code/python/"> 
    <link rel="shortcut icon" href="../../../favicon.ico">
    <title>Python - SendCloud 文档中心</title>
    <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.0.3.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
    
</head>
<body>
    <div class="navbar navbar-default" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="http://sendcloud.sohu.com">SendCloud 文档中心</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav navbar-right">
                
                  <li class="pull-left">
                    
                    <a href="../../..">文档首页</a>
                    
                  </li>
                
                  <li class="pull-left">
                    
                    <a href="../../../guide/base/">开发者指南</a>
                    
                  </li>
                
                  <li class="pull-left">
                    
                    <a href="../../../email/">邮件API</a>
                    
                  </li>
                
                  <li class="pull-left">
                    
                    <a href="../../../sms/">短信API</a>
                    
                  </li>
                
                  <li class="pull-left active">
                    
                    <a href="../../">代码示例</a>
                    
                  </li>
                
                  <li class="pull-left">
                    
                    <a href="../../../faq/">FAQ</a>
                    
                  </li>
                
                  <li class="pull-left">
                    
                    <a href="../../../test/">测试平台</a>
                    
                  </li>
                
                </ul>
            

            
            <!-- Search, Navigation and Repo links -->
            <!-- <ul class="nav navbar-nav navbar-right">
                
                
                
                <li>
                    <a href="https://github.com/sendcloud2013/sendcloud_docs/">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul> -->
            
        </div>
    </div>
</div>
    <div class="container main">
         <div class="toolbar clearfix">
  <ol class="breadcrumb pull-left">
    <li><a href="../../..">文档</a></li>
    <li>Python</li>
  </ol>

  
    
      <a href="https://github.com/sendcloud2013/sendcloud_docs/" class="github-edit pull-right"><i class="fa fa-github"></i> Edit on GitHub</a>
    
  

</div>
        <div class="col-md-3"><div class="bs-sidebar hidden-print" data-spy="affix" data-offset-top="80" role="complementary">
    <ul class="nav bs-sidenav">
     
      
        
      

    
      
        
      

    
      
        
      

    
      
        
      

    
      
        
          

              <li class="">
                <a class="itm-l1" href="../../">代码示例</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../curl/">Curl</a>
                
              </li>

          

              <li class="active">
                <a class="itm-l1" href="./">Python</a>
                
                  <ul class="nav">
                  
                    <li class="active "><a href="#webapi">WEBAPI</a></li>
                    
                  
                    <li class=""><a href="#smtp">SMTP</a></li>
                    
                  
                  </ul>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../java/">Java</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../php/">Php</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../ruby/">Ruby</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../perl/">Perl</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../csharp/">C#</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../golang/">Golang</a>
                
              </li>

          

              <li class="">
                <a class="itm-l1" href="../nodejs/">Node.js</a>
                
              </li>

          
        
      

    
      
        
      

    
      
        
      

    
    </ul>
</div></div>
        <div class="col-md-9 content-body" role="main">
             

<h1>Python</h1>

<h2 id="webapi">WEBAPI</h2>
<pre><code># -*- coding:utf-8 -*-                                                          

import requests                                                                 

url = &quot;http://sendcloud.sohu.com/webapi/mail.send.json&quot;                         

params = {                                                                      
    &quot;api_user&quot;: &quot;***&quot;, # 使用api_user和api_key进行验证                       
    &quot;api_key&quot; : &quot;***&quot;,                                             
    &quot;to&quot; : &quot;to1@domain.com;to2@domain.com&quot;, # 收件人地址, 用正确邮件地址替代, 多个地址用';'分隔
    &quot;from&quot; : &quot;sendcloud@sendcloud.org&quot;, # 发信人, 用正确邮件地址替代                                        
    &quot;fromname&quot; : &quot;SendCloud&quot;,                                                    
    &quot;subject&quot; : &quot;SendCloud python webapi example&quot;,                              
    &quot;html&quot;: &quot;欢迎使用SendCloud&quot;,
    &quot;resp_email_id&quot;: &quot;true&quot;,
}                                                                               

filename = &quot;/path/file.pdf&quot;
display_filename = &quot;attachment.pdf&quot;

files = { &quot;file1&quot; : (display_filename, open(filename, &quot;rb&quot;))}

r = requests.post(url, files=files, data=params)

print r.text
</code></pre>

<p><a href="../../downloads/code/python_webapi.py">downloads</a></p>
<hr />
<h2 id="smtp">SMTP</h2>
<pre><code># -*- coding:utf-8 -*-                                                          

from smtplib import SMTP
from email.mime.multipart import MIMEMultipart
from email.header import Header
from email.mime.base import MIMEBase
from email.mime.text import MIMEText
from email.utils import COMMASPACE, formatdate, formataddr
from email import encoders

import base64, time, simplejson, os, json
from datetime import datetime, date

HOST = 'smtpcloud.sohu.com'
PORT = 25
API_USER = '...'
API_KEY = '...'

DEBUG_MODE = False
USE_SSL = False

def _message_id(reply):
    message_id = None

    if str(reply[0]) == '250': 
        message_id = str(reply[1]).split('#')[1]

    return message_id

def send(mail_from, ffrom, rcpt_tos, reply_to, subject, content, files):                                                                  
    ret = {}

    s = SMTP('%s:%d' % (HOST, PORT))
    s.set_debuglevel(DEBUG_MODE)
    if USE_SSL:
        s.starttls()
    s.login(API_USER, API_KEY)

    for rcpt_to in rcpt_tos:
        ret[rcpt_to] = None

        msg = MIMEMultipart('alternative')
        msg['subject'] = subject
        msg['from'] = ffrom
        msg['reply-to'] = reply_to
        msg['to'] = rcpt_to

        part = MIMEText(content, 'html', 'utf8')
        msg.attach(part)

        for f in files:
            part = MIMEBase('application', 'octet-stream') #'octet-stream': binary data 
            part.set_payload(open(f, 'rb').read())
            encoders.encode_base64(part)

            # 如果附件名称含有中文, 则 filename 要转换为gb2312编码, 否则就会出现乱码
            # unicode转换方法:  basename.encode('gb2312')  
            # utf-8转换方法:    basename.decode('utf-8').encode('gb2312')  
            filename = os.path.basename(f)
            part.add_header('Content-Disposition', 'attachment; filename=&quot;%s&quot;' % filename.decode('utf8').encode('gb2312'))
            msg.attach(part)

        s.mail(mail_from)
        s.rcpt(rcpt_to)
        reply_data = s.data(msg.as_string())
        s.rset()

        message_id = _message_id(reply_data)
        ret[rcpt_to] = message_id + '0$' + rcpt_to

    s.quit()

    print ret
    return ret

def sendn(mail_from, ffrom, x_smtpapi, reply_to, subject, content, files): 
    ret = {}

    s = SMTP('%s:%d' % (HOST, PORT))
    s.set_debuglevel(DEBUG_MODE)
    if USE_SSL:
        s.starttls()
    s.login(API_USER, API_KEY)

    msg = MIMEMultipart('alternative')
    msg['subject'] = subject
    msg['from'] = ffrom
    msg['reply-to'] = reply_to
    msg['X-SMTPAPI'] = Header(base64.b64encode(simplejson.dumps(x_smtpapi)))

    part = MIMEText(content, 'html', 'utf8')
    msg.attach(part)

    for f in files:
        part = MIMEBase('application', 'octet-stream') #'octet-stream': binary data 
        part.set_payload(open(f, 'rb').read())
        encoders.encode_base64(part)

        # 如果附件名称含有中文, 则 filename 要转换为gb2312编码, 否则就会出现乱码
        # unicode转换方法:  basename.encode('gb2312')  
        # utf-8转换方法:    basename.decode('utf-8').encode('gb2312')  
        filename = os.path.basename(f)
        part.add_header('Content-Disposition', 'attachment; filename=&quot;%s&quot;' % filename.decode('utf8').encode('gb2312'))
        msg.attach(part)

    s.mail(mail_from)
    # now, rcpt_to is useless due to X_SMTPAPI
    s.rcpt(x_smtpapi['to'][0])
    reply_data = s.data(msg.as_string())
    s.quit()

    message_id = _message_id(reply_data)

    for rcpt_to in x_smtpapi['to']:
        ret[rcpt_to] = message_id + str(x_smtpapi['to'].index(rcpt_to)) + '$' + rcpt_to

    print ret
    return ret

def test_send():
    mail_from = 'anything@ifaxin.com' # useless
    ffrom = formataddr((str(Header(u'爱发信客服支持', 'utf-8')), &quot;support@ifaxin.com&quot;))
    rcpt_tos = [&quot;ben@ifaxin.com&quot;, &quot;joe@ifaxin.com&quot;]
    reply_to = 'service@ifaxin.com'
    subject = '关于问题1901的回复'
    content = &quot;请登录爱发信, 查看此问题的回复.  &lt;br/&gt; &lt;a href='http://www.ifaxin.com'&gt;http://www.ifaxin.com&lt;/a&gt;&quot;
    files = ['/path/file1', '/path/files2', ]

    send(mail_from, ffrom, rcpt_tos, reply_to, subject, content, files)

def test_sendn():
    mail_from = 'anything@ifaxin.com' # useless
    ffrom = formataddr((str(Header(u'爱发信客服支持', 'utf-8')), &quot;support@ifaxin.com&quot;))
    x_smtpapi = {
        &quot;to&quot;: [&quot;ben@ifaxin.com&quot;, &quot;joe@ifaxin.com&quot;,],
        &quot;sub&quot;: {
            &quot;%name%&quot;: [&quot;Ben&quot;, &quot;Joe&quot;],
            &quot;%money%&quot;:[288, 497]
        },
        &quot;filters&quot;: {
            &quot;subscription_tracking&quot;: { &quot;settings&quot;: { &quot;enable&quot;: &quot;1&quot; } },
            &quot;open_tracking&quot;        : { &quot;settings&quot;: { &quot;enable&quot;: &quot;1&quot; } },
            &quot;click_tracking&quot;       : { &quot;settings&quot;: { &quot;enable&quot;: &quot;1&quot; } }
        }
    }
    reply_to = 'service@ifaxin.com'
    subject = &quot;爱发信2015年1月份消费账单&quot;
    content = &quot;亲爱的%name%: &lt;br/&gt; 您好! 您本月在爱发信的消费金额为: %money% 元. &lt;br/&gt; &lt;br/&gt; &lt;a href='http://www.ifaxin.com'&gt;http://www.ifaxin.com&lt;/a&gt;&quot;
    files = ['/path/file1', '/path/files2', ]

    sendn(mail_from, ffrom, x_smtpapi, reply_to, subject, content, files)

def main():
    # send email one by one
    test_send()

    # send email with x_smtpapi
    test_sendn()

if __name__ == '__main__':                                                      
    main()

</code></pre>

<p><a href="../../downloads/code/python_smtp.py">downloads</a></p>
            <div class="ds-thread" data-thread-key="Python" data-title="Python" data-url=""></div>
        </div>
        
    </div>
    <footer class="clearfix footer">
        <div class="container">
            <ul class="list-unstyled list-inline pull-left">
                <li><a href="http://sendcloud.sohu.com/aboutUs.html">关于我们</a> </li>
                <li><a href="http://sendcloud.sohu.com/aboutUs.html#agreement">服务协议</a></li>
                <li><a href="http://sendcloud.sohu.com/aboutUs.html#partners">合作伙伴</a></li>
                <li><a href="https://sendcloud.kf5.com/" target="_blank">帮助中心</a></li>
            </ul>
            <p class="pull-right">copyright 2015 &copy; SendCloud</p>
        </div>
    </footer>
    
    <script src="../../../js/jquery-1.11.2.min.js"></script>
    <script src="../../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../../js/prettify-1.0.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    <script src="../../../js/base.js"></script>
    <script type="text/javascript">
    $('.ds-thread').attr('data-url', location.href).attr('data-thread-key', location.href)

    var duoshuoQuery = {
        short_name: "sendcloud"
    };
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    </body>

</html>